---
# Bootstrap playbook - First run after VM creation
- name: Bootstrap Docker Hosts
  hosts: docker_hosts
  become: true
  gather_facts: true

  tasks:
    - name: Set hostname
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"

    - name: Update all packages
      ansible.builtin.dnf:
        name: "*"
        state: latest
        update_cache: true

    - name: Install base packages
      ansible.builtin.dnf:
        name:
          - vim
          - git
          - curl
          - wget
          - htop
          - tmux
          - net-tools
          - bind-utils
          - firewalld
          - python3-firewall
        state: present

    - name: Ensure ansible user has sudo without password
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/ansible
        line: "ansible ALL=(ALL) NOPASSWD: ALL"
        create: true
        mode: '0440'
        validate: 'visudo -cf %s'

    - name: Configure SSH - disable password authentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PasswordAuthentication"
        line: "PasswordAuthentication no"
        state: present
      notify: Restart sshd

    - name: Configure SSH - disable root login
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PermitRootLogin"
        line: "PermitRootLogin no"
        state: present
      notify: Restart sshd

    - name: Enable and start firewalld
      ansible.builtin.systemd:
        name: firewalld
        enabled: true
        state: started

    - name: Configure firewall - allow SSH
      ansible.posix.firewalld:
        service: ssh
        permanent: true
        state: enabled
        immediate: true

    - name: Configure automatic security updates (DNF5)
      ansible.builtin.dnf:
        name: dnf5-plugin-automatic
        state: present

    - name: Configure dnf5-automatic for security updates only
      ansible.builtin.lineinfile:
        path: /etc/dnf/automatic.conf
        regexp: "^upgrade_type"
        line: "upgrade_type = security"
        state: present
        create: true

    - name: Enable dnf5-automatic timer
      ansible.builtin.systemd:
        name: dnf5-automatic.timer
        enabled: true
        state: started

  handlers:
    - name: Restart sshd
      ansible.builtin.systemd:
        name: sshd
        state: restarted
